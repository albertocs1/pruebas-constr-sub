<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Partes de Obra MMX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e40af">

<style>
html,body{margin:0;height:100%;font-family:Segoe UI,Arial}
body{background:#f4f6f8;color:#111}
.hidden{display:none!important}
.center{display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;gap:12px}
button{cursor:pointer}
.loader{width:40px;height:40px;border:4px solid #ddd;border-top:4px solid #2563eb;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.dayCell{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;border:1px solid #ddd;padding:8px;min-width:60px;min-height:60px;position:relative;background:#fff;border-radius:4px;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
.partBadge{background:#2563eb;color:#fff;font-size:10px;border-radius:4px;padding:2px 4px;margin-top:4px}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;padding:4px}
#partModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000}
#partModalContent{background:#fff;padding:20px;border-radius:8px;max-width:600px;width:90%;max-height:90%;overflow:auto;display:flex;flex-direction:column;gap:12px}
#trabajosContainer div{display:flex;gap:8px;margin-bottom:6px}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen" class="center">
  <div class="loader"></div>
  <div>Cargando datos…</div>
</div>

<!-- LOGIN -->
<div id="loginView" class="center hidden">
  <h2>Iniciar sesión</h2>
  <input id="loginEmail" placeholder="Email"><br><br>
  <input id="loginPassword" type="password" placeholder="Contraseña"><br><br>
  <button onclick="login()">Entrar</button>
  <button onclick="showRegister()">Crear cuenta</button>
</div>

<!-- REGISTER -->
<div id="registerView" class="hidden center">
  <h2>Crear cuenta</h2>
  <input id="regEmail" type="email" placeholder="Email"><br><br>
  <input id="regPassword" type="password" placeholder="Contraseña"><br><br>
  <label>Tipo de usuario:</label><br>
  <select id="regRole">
    <option value="contratista">Contratista</option>
    <option value="subcontratista">Subcontratista</option>
  </select><br><br>
  <button onclick="register()">Registrarse</button><br><br>
  <button onclick="showLogin()">Volver al login</button>
</div>

<!-- APP -->
<div id="appView" class="hidden" style="padding:16px">

  <div id="companyMenu">
    <h2>Empresas</h2>
    <p id="currentUserEmail"></p>
    <div id="companyList"></div><br>
    <input id="newCompanyName" placeholder="Nueva empresa">
    <button onclick="addCompany()">Añadir</button>
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <div id="calendarView" class="hidden">
    <button onclick="backToMenu()">← Volver</button>
    <h2 id="calendarTitle"></h2>
    <div id="calendar"></div>
  </div>

</div>

<!-- MODAL PARTES -->
<div id="partModal" class="hidden">
  <div id="partModalContent">
    <h3>Día <span id="modalDayTitle"></span></h3>

    <label>Trabajador frecuente:</label>
    <select id="parteTrabajadorFrecuente">
      <option value="">-- Selecciona --</option>
    </select>

    <label>Nombre del trabajador:</label>
    <input type="text" id="parteNombre">

    <label>Rango:</label>
    <input type="text" id="parteRango">

    <div id="trabajosContainer"><h4>Trabajos realizados</h4></div>
    <button onclick="addTrabajo()">+ Añadir trabajo</button>

    <label>Horas totales:</label>
    <input type="number" id="horasTotales" readonly style="background:#eee;">

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
      <button onclick="guardarParte()">Guardar</button>
      <button onclick="cerrarModalParte()">Cancelar</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyB10pBy8k5Z_cQNHuoKwM8neBEUzysktkk",
  authDomain: "pruebas-contr-sub.firebaseapp.com",
  databaseURL: "https://pruebas-contr-sub-default-rtdb.firebaseio.com",
  projectId: "pruebas-contr-sub"
});
const auth = firebase.auth();
const db = firebase.database();

/* ================= ESTADO ================= */
let currentUser = null;
let companyData = {};
let currentCompany = null;
let currentMonth = null;
let currentYear = null;
let partesDia = {};
let currentDay = null;

/* ================= UTIL ================= */
function show(id){document.getElementById(id).classList.remove('hidden')}
function hide(id){document.getElementById(id).classList.add('hidden')}

/* ================= LOGIN / REGISTER ================= */
async function login(){
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!email||!password){alert('Email y contraseña requeridos');return;}
  try{
    const cred = await auth.signInWithEmailAndPassword(email,password);
    currentUser=cred.user;
    await waitForProfile(currentUser.uid);
  }catch(e){alert('Error en login: '+e.message);}
}
async function register(){
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value;
  const role=document.getElementById('regRole').value;
  if(!email||!password){alert('Completa email y contraseña'); return;}
  try{
    const cred = await auth.createUserWithEmailAndPassword(email,password);
    await db.ref('users/'+cred.user.uid).set({email,role,createdAt:Date.now()});
    alert('Cuenta creada correctamente. Ya puedes iniciar sesión.');
    showLogin();
  }catch(e){alert('Error al crear la cuenta: '+e.message);}
}
function showRegister(){hide('loginView');show('registerView');}
function showLogin(){hide('registerView');show('loginView');}

/* ================= PERFIL / EMPRESAS ================= */
auth.onAuthStateChanged(user=>{
  if(!user){hide('loadingScreen');show('loginView');hide('appView');return;}
  currentUser=user;
  waitForProfile(currentUser.uid);
});

async function waitForProfile(uid){
  const snapshot = await db.ref('users/'+uid).once('value');
  if(!snapshot.exists()){alert("No se pudo cargar el perfil"); auth.signOut(); return;}
  currentUser.role = snapshot.val().role;
  await loadCompanies();
  showMenu();
}

async function loadCompanies(){
  const snapshot = await db.ref('users/'+currentUser.uid+'/companies').once('value');
  companyData = snapshot.val()||{};
}

function showMenu(){
  hide('loadingScreen');hide('calendarView');show('appView');show('companyMenu');
  document.getElementById('currentUserEmail').textContent = `${currentUser.email} (${currentUser.role})`;
  renderCompanyList();
}

function renderCompanyList(){
  const list=document.getElementById('companyList');
  list.innerHTML='';
  Object.keys(companyData).forEach(name=>{
    const div=document.createElement('div');
    div.textContent=name;
    div.onclick=()=>openCompany(name);
    list.appendChild(div);
  });
}

async function addCompany(){
  const name = document.getElementById('newCompanyName').value.trim();
  if(!name){alert("Introduce un nombre");return;}
  if(companyData[name]){alert("Ya existe");return;}
  companyData[name]={calendar:{},templates:[]};
  await db.ref('users/'+currentUser.uid+'/companies/'+name).set(companyData[name]);
  renderCompanyList();
  await openCompany(name);
}

function backToMenu(){
  currentCompany=null;
  hide('calendarView');
  show('companyMenu');
}

/* ================= CALENDARIO ================= */
async function openCompany(name){
  show('loadingScreen');
  hide('companyMenu');
  currentCompany=name;
  const now=new Date();
  currentMonth=now.getMonth();
  currentYear=now.getFullYear();

  const snapshot = await db.ref(`users/${currentUser.uid}/companies/${name}`).once('value');
  if(!snapshot.exists()){alert("Error al cargar empresa"); backToMenu(); return;}
  companyData[name] = snapshot.val();

  cargarPartesDiaFromDB(companyData[name].calendar || {});
  renderCalendar();
}

function cargarPartesDiaFromDB(calendarData){
  partesDia={};
  if(!calendarData) return;
  const yearData = calendarData[currentYear]||{};
  const monthData = yearData[currentMonth+1]||{};
  Object.keys(monthData).forEach(day=>{
    partesDia[parseInt(day)] = monthData[day];
  });
}

function renderCalendar(){
  hide('loadingScreen'); show('calendarView');
  const calendar=document.getElementById('calendar');
  calendar.innerHTML='';
  document.getElementById('calendarTitle').textContent = `${currentMonth+1}/${currentYear}`;

  const daysInMonth = new Date(currentYear,currentMonth+1,0).getDate();
  for(let d=1;d<=daysInMonth;d++){
    const cell=document.createElement('div');
    cell.classList.add('dayCell');

    const dayNum=document.createElement('div'); dayNum.textContent=d; dayNum.style.fontWeight='bold';
    cell.appendChild(dayNum);

    // Mostrar trabajador si hay parte
    const partes = partesDia[d]||[];
    partes.forEach(p=>{
      const badge=document.createElement('div');
      badge.classList.add('partBadge');
      badge.textContent=p.trabajador;
      cell.appendChild(badge);
    });

    // Botón +
    const btn = document.createElement('button');
    btn.textContent='+';
    btn.style.position='absolute';
    btn.style.bottom='4px';
    btn.style.right='4px';
    btn.style.width='24px'; btn.style.height='24px';
    btn.style.border='none'; btn.style.borderRadius='50%';
    btn.style.background='#2563eb'; btn.style.color='#fff';
    btn.onclick=()=>abrirModalParte(d);
    cell.appendChild(btn);

    calendar.appendChild(cell);
  }
}

/* ================= PARTES ================= */
function abrirModalParte(day){
  currentDay=day;
  partesDia[day] = partesDia[day]||[];
  show('partModal');
  document.getElementById('modalDayTitle').textContent=day;

  const container=document.getElementById('trabajosContainer');
  container.innerHTML='';

  // Cargar trabajadores frecuentes
  const select=document.getElementById('parteTrabajadorFrecuente');
  select.innerHTML='<option value="">-- Selecciona --</option>';
  const nombres = new Set();
  Object.values(partesDia).forEach(arr=>arr.forEach(p=>nombres.add(p.trabajador)));
  nombres.forEach(n=>select.appendChild(new Option(n,n)));

  if(partesDia[day].length>0){
    const parte = partesDia[day][0];
    document.getElementById('parteNombre').value=parte.trabajador;
    document.getElementById('parteRango').value=parte.rango;
    parte.trabajos.forEach(t=>addTrabajo(t.descripcion,t.horas));
  } else addTrabajo();

  actualizarHorasTotales();
}

function cerrarModalParte(){ hide('partModal'); }

function addTrabajo(desc='',horas=''){
  const container=document.getElementById('trabajosContainer');
  const div=document.createElement('div');
  const descInput=document.createElement('input');
  descInput.placeholder='Trabajo realizado'; descInput.value=desc; descInput.style.flex='2';
  const horasInput=document.createElement('input'); horasInput.type='number'; horasInput.placeholder='Horas'; horasInput.value=horas; horasInput.style.flex='1';
  horasInput.addEventListener('input',actualizarHorasTotales);
  const btnDel=document.createElement('button'); btnDel.textContent='Eliminar'; btnDel.onclick=()=>{div.remove(); actualizarHorasTotales();};
  div.appendChild(descInput); div.appendChild(horasInput); div.appendChild(btnDel);
  container.appendChild(div);
}

function actualizarHorasTotales(){
  const container=document.getElementById('trabajosContainer');
  let total=0;
  container.querySelectorAll('input[type="number"]').forEach(inp=>{
    const val=parseFloat(inp.value);
    if(!isNaN(val)) total+=val;
  });
  document.getElementById('horasTotales').value=total;
}

async function guardarParte(){
  const trabajador=document.getElementById('parteNombre').value.trim();
  const rango=document.getElementById('parteRango').value.trim();
  if(!trabajador || !rango){alert('Completa nombre y rango');return;}
  const trabajos=[];
  document.querySelectorAll('#trabajosContainer > div').forEach(div=>{
    const inputs=div.querySelectorAll('input');
    const desc=inputs[0].value.trim();
    const hrs=parseFloat(inputs[1].value);
    if(desc && !isNaN(hrs)) trabajos.push({descripcion:desc,horas:hrs});
  });
  if(trabajos.length===0){alert('Añade al menos un trabajo'); return;}
  const horasTotales = trabajos.reduce((acc,t)=>acc+t.horas,0);
  partesDia[currentDay] = [{trabajador,rango,trabajos,horasTotales}];

  await db.ref(`users/${currentUser.uid}/companies/${currentCompany}/calendar/${currentYear}/${currentMonth+1}/${currentDay}`)
          .set(partesDia[currentDay]);

  cerrarModalParte();
  renderCalendar();
}

/* ================= LOGOUT ================= */
function logout(){auth.signOut();}
</script>
</body>
</html>
