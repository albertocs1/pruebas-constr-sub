<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Partes de Obra MMX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e40af">

<style>
html,body{margin:0;height:100%;font-family:Segoe UI,Arial}
body{background:#f4f6f8;color:#111}

.hidden{display:none!important}
.center{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  flex-direction:column;
  gap:12px;
}
button{cursor:pointer}
.loader{
  width:40px;height:40px;
  border:4px solid #ddd;
  border-top:4px solid #2563eb;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
.dayCell{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  border:1px solid #ddd;
  padding:8px;
  min-width:60px;
  min-height:60px;
  cursor:pointer;
  position:relative;
}
.partBadge{
  background:#2563eb;
  color:#fff;
  font-size:10px;
  border-radius:4px;
  padding:2px 4px;
  margin-top:4px;
}
#partModal{
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);
  display:flex;
  justify-content:center;
  align-items:center;
}
#partModalContent{
  background:#fff;
  padding:20px;
  border-radius:8px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
</style>
</head>

<body>

<!-- LOADING GLOBAL -->
<div id="loadingScreen" class="center">
  <div class="loader"></div>
  <div>Cargando datos…</div>
</div>

<!-- LOGIN -->
<div id="loginView" class="center hidden">
  <h2>Iniciar sesión</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button onclick="login()">Entrar</button>
  <button onclick="showRegister()">Crear cuenta</button>
</div>
  
<div id="registerView" style="display:none; padding:20px;">
  <h2>Crear cuenta</h2>
  <input id="regEmail" type="email" placeholder="Email"><br><br>
  <input id="regPassword" type="password" placeholder="Contraseña"><br><br>
  <label>Tipo de usuario:</label><br>
  <select id="regRole">
    <option value="contratista">Contratista</option>
    <option value="subcontratista">Subcontratista</option>
  </select><br><br>
  <button onclick="register()">Registrarse</button><br><br>
  <button onclick="showLogin()">Volver al login</button>
</div>

<!-- APP -->
<div id="appView" class="hidden">

  <div id="companyMenu">
    <h2>Empresas</h2>
    <p id="currentUserEmail"></p>
    <div id="companyList"></div>
    <input id="newCompanyName" placeholder="Nueva empresa">
    <button onclick="addCompany()">Añadir</button>
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <div id="calendarView" class="hidden">
    <button onclick="backToMenu()">← Volver</button>
    <h2 id="calendarTitle"></h2>
    <div id="calendar" style="display:flex;flex-wrap:wrap;gap:4px"></div>
  </div>

</div>

<!-- MODAL PARTES -->
<div id="partModal" class="hidden">
  <div id="partModalContent">
    <h3 id="modalDayTitle"></h3>
    <textarea id="partText" placeholder="Descripción del parte" rows="4"></textarea>
    <button onclick="savePart()">Guardar parte</button>
    <button onclick="closePartModal()">Cancelar</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyB10pBy8k5Z_cQNHuoKwM8neBEUzysktkk",
  authDomain: "pruebas-contr-sub.firebaseapp.com",
  databaseURL: "https://pruebas-contr-sub-default-rtdb.firebaseio.com",
  projectId: "pruebas-contr-sub"
});
const auth = firebase.auth();
const db = firebase.database();

/* ================= ESTADO GLOBAL ================= */
let currentUser=null;
let companyData={};
let currentCompany=null;
let currentMonth=null;
let currentYear=null;
let selectedDay=null;

/* ================= UTIL ================= */
function show(id){document.getElementById(id).classList.remove('hidden')}
function hide(id){document.getElementById(id).classList.add('hidden')}

/* ================= LOGIN / REGISTER ================= */
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!email||!password){alert('Ingrese email y contraseña'); return;}
  try {
    const cred=await auth.signInWithEmailAndPassword(email,password);
    currentUser=cred.user;
    await waitForProfile(currentUser.uid);
  } catch(e){alert('Error en login: '+e.message);}
}

function showRegister(){hide('loginView');show('registerView');}
function showLogin(){hide('registerView');show('loginView');}

async function register(){
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value;
  const role=document.getElementById('regRole').value;
  if(!email||!password){alert('Rellena email y contraseña'); return;}
  try{
    const cred=await auth.createUserWithEmailAndPassword(email,password);
    await db.ref('users/'+cred.user.uid).set({email,role,createdAt:Date.now()});
    alert('Cuenta creada correctamente. Ya puedes iniciar sesión.');
    showLogin();
  }catch(e){alert('Error al crear la cuenta: '+e.message);}
}

/* ================= PERFIL / EMPRESAS ================= */
auth.onAuthStateChanged(user=>{
  if(!user){hide('loadingScreen');show('loginView');hide('appView');return;}
  currentUser=user;
  waitForProfile(user.uid);
});

async function waitForProfile(uid){
  const snapshot=await db.ref('users/'+uid).once('value');
  if(!snapshot.exists()){alert("No se pudo cargar el perfil"); auth.signOut(); return;}
  currentUser.role=snapshot.val().role;
  await loadCompanies();
  showMenu();
}

async function loadCompanies(){
  const s=await db.ref('users/'+currentUser.uid+'/companies').once('value');
  companyData=s.val()||{};
}

function showMenu(){
  hide('loadingScreen');hide('calendarView');show('appView');show('companyMenu');
  document.getElementById('currentUserEmail').textContent=`${currentUser.email} (${currentUser.role})`;
  renderCompanyList();
}

function renderCompanyList(){
  const list=document.getElementById('companyList');
  list.innerHTML='';
  Object.keys(companyData).forEach(name=>{
    const d=document.createElement('div');
    d.textContent=name;
    d.onclick=()=>openCompany(name);
    list.appendChild(d);
  });
}

async function addCompany(){
  const name=document.getElementById('newCompanyName').value.trim();
  if(!name){alert("Introduce un nombre");return;}
  if(companyData[name]){alert("Ya existe esa empresa"); return;}
  companyData[name]={calendar:{},templates:[]};
  await db.ref('users/'+currentUser.uid+'/companies/'+name).set(companyData[name]);
  renderCompanyList();
  await openCompany(name);
}

/* ================= CALENDARIO ================= */
async function openCompany(name){
  show('loadingScreen');hide('companyMenu');
  currentCompany=name;
  const now=new Date(); currentMonth=now.getMonth(); currentYear=now.getFullYear();
  await loadCompanies();
  renderCalendar();
}

function renderCalendar(){
  hide('loadingScreen');
  show('calendarView');

  calendar.innerHTML='';
  calendarTitle.textContent = `${currentMonth+1}/${currentYear}`;

  const days = new Date(currentYear, currentMonth+1,0).getDate();

  for(let d=1; d<=days; d++){
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.style.padding = "8px";
    cell.style.border = "1px solid #ddd";
    cell.style.cursor = "pointer";

    cell.onclick = () => abrirModalParte(d);

    calendar.appendChild(cell);
  }
}

/* ================= PARTES ================= */
let currentDay=null;   // Día seleccionado en el calendario
let partesDia={};      // Partes guardadas para el día seleccionado

function abrirModalParte(day){
  currentDay = day;
  partesDia[day] = partesDia[day] || [];

  document.getElementById('parteModal').classList.remove('hidden');

  // Limpiar container
  document.getElementById('trabajosContainer').innerHTML = '';

  // Cargar trabajadores frecuentes
  cargarTrabajadoresFrecuentes();

  // Si ya hay partes guardadas en ese día, mostrar la primera (puedes ajustar para seleccionar cuál mostrar)
  if(partesDia[day].length > 0){
    const parte = partesDia[day][0]; // tomamos la primera parte
    document.getElementById('parteTrabajadorFrecuente').value = parte.trabajador;
    document.getElementById('parteNombre').value = parte.trabajador;
    document.getElementById('parteRango').value = parte.rango;

    parte.trabajos.forEach(t => addTrabajo(t.descripcion, t.horas));
  } else {
    // Si no hay partes, añadir un trabajo inicial vacío
    addTrabajo();
  }

  actualizarHorasTotales();
}


function cerrarModalParte(){
  document.getElementById('parteModal').classList.add('hidden');
}

function cargarTrabajadoresFrecuentes(){
  const select = document.getElementById('parteTrabajadorFrecuente');
  select.innerHTML = '<option value="">-- Selecciona --</option>';
  // Recorre todas las partes de la empresa para rellenar el select
  const nombres = new Set();
  Object.values(partesDia).forEach(arr => {
    arr.forEach(p => nombres.add(p.trabajador));
  });
  nombres.forEach(n => {
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    select.appendChild(opt);
  });
}

// Cuando se selecciona un trabajador frecuente, rellena automáticamente el nombre
document.getElementById('parteTrabajadorFrecuente')?.addEventListener('change', function(){
  document.getElementById('parteNombre').value = this.value;
});

function addTrabajo(descripcion='', horas=''){
  const container = document.getElementById('trabajosContainer');
  const div = document.createElement('div');
  div.style.display = 'flex';
  div.style.gap = '8px';
  div.style.marginBottom = '6px';

  const descInput = document.createElement('input');
  descInput.placeholder = 'Trabajo realizado';
  descInput.value = descripcion;
  descInput.style.flex = '2';

  const horasInput = document.createElement('input');
  horasInput.type = 'number';
  horasInput.placeholder = 'Horas';
  horasInput.value = horas;
  horasInput.style.flex = '1';
  horasInput.addEventListener('input', actualizarHorasTotales);

  const btnEliminar = document.createElement('button');
  btnEliminar.textContent = 'Eliminar';
  btnEliminar.onclick = () => { div.remove(); actualizarHorasTotales(); };

  div.appendChild(descInput);
  div.appendChild(horasInput);
  div.appendChild(btnEliminar);

  container.appendChild(div);
}

function actualizarHorasTotales(){
  const container = document.getElementById('trabajosContainer');
  let total = 0;
  container.querySelectorAll('input[type="number"]').forEach(inp => {
    const val = parseFloat(inp.value);
    if(!isNaN(val)) total += val;
  });
  document.getElementById('horasTotales').value = total;
}

async function guardarParte(){
  const trabajador = document.getElementById('parteNombre').value.trim();
  const rango = document.getElementById('parteRango').value.trim();
  if(!trabajador || !rango){
    alert('Completa nombre y rango');
    return;
  }

  const trabajos = [];
  document.getElementById('trabajosContainer').querySelectorAll('div').forEach(div=>{
    const inputs = div.querySelectorAll('input');
    const desc = inputs[0].value.trim();
    const hrs = parseFloat(inputs[1].value);
    if(desc && !isNaN(hrs)) trabajos.push({descripcion: desc, horas: hrs});
  });

  if(trabajos.length === 0){
    alert('Añade al menos un trabajo con horas');
    return;
  }

  const horasTotales = trabajos.reduce((acc,t)=>acc+t.horas,0);

  // Si ya hay una parte, actualizamos la primera
  if(partesDia[currentDay].length > 0){
    partesDia[currentDay][0] = {trabajador, rango, trabajos, horasTotales};
  } else {
    partesDia[currentDay].push({trabajador, rango, trabajos, horasTotales});
  }

  await db.ref(`users/${currentUser.uid}/companies/${currentCompany}/calendar/${currentYear}/${currentMonth+1}/${currentDay}`)
          .set(partesDia[currentDay]);

  cerrarModalParte();
  alert('Parte guardado correctamente!');
}

/* ================= LOGOUT / VOLVER ================= */
function logout(){auth.signOut();}
function backToMenu(){currentCompany=null;showMenu();}


</script>

<!-- MODAL DE PARTES -->
<div id="parteModal" class="hidden" style="
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:1000;
">
  <div style="
    background:#fff;
    padding:20px;
    border-radius:8px;
    max-width:600px;
    width:90%;
    max-height:90%;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:12px;
  ">
    <h3>Nuevo Parte</h3>

    <label>Trabajador frecuente:</label>
    <select id="parteTrabajadorFrecuente">
      <option value="">-- Selecciona --</option>
    </select>

    <label>Nombre del trabajador:</label>
    <input type="text" id="parteNombre">

    <label>Rango:</label>
    <input type="text" id="parteRango">

    <div id="trabajosContainer">
      <h4>Trabajos realizados</h4>
      <!-- Aquí se añadirán dinámicamente los trabajos -->
    </div>

    <button onclick="addTrabajo()">+ Añadir trabajo</button>

    <label>Horas totales:</label>
    <input type="number" id="horasTotales" readonly style="background:#eee;">

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
      <button onclick="guardarParte()">Guardar</button>
      <button onclick="cerrarModalParte()">Cancelar</button>
    </div>
  </div>
</div>


</body>
</html>
