<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Partes de Obra MMX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e40af">

<style>
html,body{margin:0;height:100%;font-family:Segoe UI,Arial}
body{background:#f4f6f8;color:#111}

.hidden{display:none!important}
.center{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  flex-direction:column;
  gap:12px;
}
button{cursor:pointer}
.loader{
  width:40px;height:40px;
  border:4px solid #ddd;
  border-top:4px solid #2563eb;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<!-- LOADING GLOBAL -->
<div id="loadingScreen" class="center">
  <div class="loader"></div>
  <div>Cargando datos‚Ä¶</div>
</div>

<!-- LOGIN -->
<div id="loginView" class="center hidden">
  <h2>Iniciar sesi√≥n</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contrase√±a">
  <button onclick="login()">Entrar</button>
  <button onclick="showRegister()">Crear cuenta</button>
</div>
  
<div id="registerView" style="display:none; padding:20px;">
  <h2>Crear cuenta</h2>

  <input id="regEmail" type="email" placeholder="Email"><br><br>
  <input id="regPassword" type="password" placeholder="Contrase√±a"><br><br>

  <label>Tipo de usuario:</label><br>
  <select id="regRole">
    <option value="contratista">Contratista</option>
    <option value="subcontratista">Subcontratista</option>
  </select><br><br>

  <button onclick="register()">Registrarse</button><br><br>
  <button onclick="showLogin()">Volver al login</button>
</div>

<!-- APP -->
<div id="appView" class="hidden">

  <div id="companyMenu">
    <h2>Empresas</h2>
    <p id="currentUserEmail"></p>
    <div id="companyList"></div>
    <input id="newCompanyName" placeholder="Nueva empresa">
    <button onclick="addCompany()">A√±adir</button>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </div>

  <div id="calendarView" class="hidden">
    <button onclick="backToMenu()">‚Üê Volver</button>
    <h2 id="calendarTitle"></h2>
    <div id="calendar"></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyB10pBy8k5Z_cQNHuoKwM8neBEUzysktkk",
  authDomain: "pruebas-contr-sub.firebaseapp.com",
  databaseURL: "https://pruebas-contr-sub-default-rtdb.firebaseio.com",
  projectId: "pruebas-contr-sub"
});
const auth = firebase.auth();
const db = firebase.database();

/* ================= ESTADO GLOBAL ================= */
let currentUser=null;
let companyData={};
let currentCompany=null;
let currentMonth=null;
let currentYear=null;

/* ================= UTIL ================= */
function show(id){document.getElementById(id).classList.remove('hidden')}
function hide(id){document.getElementById(id).classList.add('hidden')}

/* ================= LOGIN ================= */
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!email || !password) {
    alert('Ingrese email y contrase√±a');
    return;
  }

  try {
    // üîπ Iniciar sesi√≥n en Firebase
    const cred = await firebase.auth().signInWithEmailAndPassword(email, password);
    const uid = cred.user.uid;

    // üîπ Esperar a que el perfil exista en la base de datos
    let userProfile = null;
    for (let attempts = 0; attempts < 10; attempts++) {
      const snapshot = await firebase.database().ref('users/' + uid).once('value');
      userProfile = snapshot.val();
      if (userProfile) break;
      await new Promise(res => setTimeout(res, 200)); // espera 200ms antes de reintentar
    }

    if (!userProfile) {
      alert('Perfil de usuario no encontrado');
      await firebase.auth().signOut();
      return;
    }

    // üîπ Guardar datos globales
    currentUser = cred.user;
    currentUser.role = userProfile.role;          // rol: "constructora" o "subcontrata"
    currentUser.companyName = userProfile.companyName || '';

    // üîπ Ocultar login y mostrar app
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').style.display = 'block';

    // üîπ Mostrar men√∫ de empresas
    showMenu();

  } catch (error) {
    alert('Error en login: ' + error.message);
  }
}


/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  if(!user){
    hide('loadingScreen');
    show('loginView');
    hide('appView');
    return;
  }

  currentUser=user;
  waitForProfile(user.uid);
});

/* ================= PERFIL ================= */
function waitForProfile(uid,attempt=0){
  if(attempt>15){
    alert("No se pudo cargar el perfil");
    auth.signOut();
    return;
  }

  db.ref('users/'+uid).once('value').then(s=>{
    if(!s.exists()){
      setTimeout(()=>waitForProfile(uid,attempt+1),200);
      return;
    }

    currentUser.role=s.val().role;
    loadCompanies();
  });
}

/* ================= EMPRESAS ================= */
function loadCompanies(){
  db.ref('users/'+currentUser.uid+'/companies')
    .once('value')
    .then(s=>{
      companyData=s.val()||{};
      showMenu();
    });
}

function showMenu(){
  hide('loadingScreen');
  hide('calendarView');
  show('appView');
  show('companyMenu');

  currentUserEmail.textContent=
    `${currentUser.email} (${currentUser.role})`;

  renderCompanyList();
}

function renderCompanyList(){
  companyList.innerHTML='';
  Object.keys(companyData).forEach(n=>{
    const d=document.createElement('div');
    d.textContent=n;
    d.onclick=()=>openCompany(n);
    companyList.appendChild(d);
  });
}

function addCompany(){
  const n=newCompanyName.value.trim();
  if(!n||companyData[n])return;
  companyData[n]={calendar:{}};
  db.ref(`users/${currentUser.uid}/companies/${n}`)
    .set(companyData[n])
    .then(()=>openCompany(n));
}

function openCompany(name){
  show('loadingScreen');
  hide('companyMenu');

  currentCompany=name;
  const now=new Date();
  currentMonth=now.getMonth();
  currentYear=now.getFullYear();

  ensureCompanyReady(0);
}

function ensureCompanyReady(attempt){
  if(attempt>10){
    companyData[currentCompany]={calendar:{}};
    renderCalendar();
    return;
  }

  loadCompanies();
  if(companyData[currentCompany]){
    renderCalendar();
  }else{
    setTimeout(()=>ensureCompanyReady(attempt+1),200);
  }
}

/* ================= CALENDARIO ================= */
function renderCalendar(){
  hide('loadingScreen');
  show('calendarView');

  calendar.innerHTML='';
  calendarTitle.textContent=
    `${currentMonth+1}/${currentYear}`;

  const days=new Date(currentYear,currentMonth+1,0).getDate();

  for(let d=1;d<=days;d++){
    const cell=document.createElement('div');
    cell.textContent=d;
    cell.style.padding="8px";
    cell.style.border="1px solid #ddd";
    calendar.appendChild(cell);
  }
}

function backToMenu(){
  currentCompany=null;
  showMenu();
}

/* ================= LOGOUT ================= */
function logout(){
  auth.signOut();
}
// ===== Navegaci√≥n entre login y registro =====
function showRegister() {
  document.getElementById('loginView').style.display = 'none';
  document.getElementById('registerView').style.display = 'block';
}

function showLogin() {
  document.getElementById('registerView').style.display = 'none';
  document.getElementById('loginView').style.display = 'block';
}
// ===== Registro de usuario con rol =====
async function register() {
  const email = document.getElementById('regEmail').value.trim();
  const password = document.getElementById('regPassword').value;
  const role = document.getElementById('regRole').value;

  if (!email || !password) {
    alert('Rellena email y contrase√±a');
    return;
  }

  try {
    // Crear usuario en Firebase Auth
    const cred = await firebase.auth().createUserWithEmailAndPassword(email, password);

    // Guardar perfil en la base de datos
    await firebase.database().ref('users/' + cred.user.uid).set({
      email: email,
      role: role,
      createdAt: Date.now()
    });

    alert('Cuenta creada correctamente. Ya puedes iniciar sesi√≥n.');
    showLogin();

  } catch (error) {
    alert('Error al crear la cuenta: ' + error.message);
  }
}

</script>

</body>
</html>
