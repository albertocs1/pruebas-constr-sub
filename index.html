<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Partes de Obra MMX</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e40af">

<style>
html,body{margin:0;height:100%;font-family:Segoe UI,Arial}
body{background:#f4f6f8;color:#111}

.hidden{display:none!important}
.center{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  flex-direction:column;
  gap:12px;
}
button{cursor:pointer}
.loader{
  width:40px;height:40px;
  border:4px solid #ddd;
  border-top:4px solid #2563eb;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

/* Calendario */
#calendar{display:grid; grid-template-columns:repeat(7,1fr); gap:5px;}
#calendar div{padding:8px; text-align:center; border:1px solid #ddd; border-radius:4px; cursor:pointer;}
#calendar div.today{background:#2563eb; color:#fff; font-weight:bold;}
#calendar div.selected{background:#34d399; color:#fff;}
</style>
</head>

<body>

<!-- LOADING GLOBAL -->
<div id="loadingScreen" class="center">
  <div class="loader"></div>
  <div>Cargando datos…</div>
</div>

<!-- LOGIN -->
<div id="loginView" class="center hidden">
  <h2>Iniciar sesión</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contraseña">
  <button onclick="login()">Entrar</button>
  <button onclick="showRegister()">Crear cuenta</button>
</div>
  
<div id="registerView" style="display:none; padding:20px;">
  <h2>Crear cuenta</h2>

  <input id="regEmail" type="email" placeholder="Email"><br><br>
  <input id="regPassword" type="password" placeholder="Contraseña"><br><br>

  <label>Tipo de usuario:</label><br>
  <select id="regRole">
    <option value="contratista">Contratista</option>
    <option value="subcontratista">Subcontratista</option>
  </select><br><br>

  <button onclick="register()">Registrarse</button><br><br>
  <button onclick="showLogin()">Volver al login</button>
</div>

<!-- APP -->
<div id="appView" class="hidden">

  <div id="companyMenu">
    <h2>Empresas</h2>
    <p id="currentUserEmail"></p>
    <div id="companyList"></div>
    <input id="newCompanyName" placeholder="Nueva empresa">
    <button onclick="addCompany()">Añadir</button>
    <button onclick="logout()">Cerrar sesión</button>
  </div>

  <div id="calendarView" class="hidden">
    <button onclick="backToMenu()">← Volver</button>
    <h2 id="calendarTitle"></h2>
    <div id="calendar"></div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyB10pBy8k5Z_cQNHuoKwM8neBEUzysktkk",
  authDomain: "pruebas-contr-sub.firebaseapp.com",
  databaseURL: "https://pruebas-contr-sub-default-rtdb.firebaseio.com",
  projectId: "pruebas-contr-sub"
});
const auth = firebase.auth();
const db = firebase.database();

/* ================= ESTADO GLOBAL ================= */
let currentUser=null;
let companyData={};
let currentCompany=null;
let currentMonth=null;
let currentYear=null;
let selectedDay=null;

/* ================= UTIL ================= */
function show(id){document.getElementById(id).classList.remove('hidden')}
function hide(id){document.getElementById(id).classList.add('hidden')}

/* ================= LOGIN ================= */
async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { alert('Ingrese email y contraseña'); return; }

  try {
    const cred = await auth.signInWithEmailAndPassword(email, password);
    currentUser = cred.user;
    const snapshot = await db.ref('users/' + currentUser.uid).once('value');
    if(!snapshot.exists()){ alert('Perfil no encontrado'); await auth.signOut(); return; }
    currentUser.role = snapshot.val().role;
    hide('loginView'); show('appView'); showMenu();
  } catch (error) { alert('Error en login: '+error.message); }
}

/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(user=>{
  if(!user){ hide('loadingScreen'); show('loginView'); hide('appView'); return; }
  currentUser=user;
  show('loadingScreen');
  db.ref('users/'+user.uid).once('value').then(s=>{
    if(s.exists()) currentUser.role=s.val().role;
    loadCompanies();
  });
});

/* ================= EMPRESAS ================= */
async function loadCompanies(){
  const snapshot = await db.ref('users/' + currentUser.uid + '/companies').once('value');
  companyData = snapshot.val() || {};
  showMenu();
}

function showMenu(){
  hide('loadingScreen'); hide('calendarView'); show('appView'); show('companyMenu');
  document.getElementById('currentUserEmail').textContent=`${currentUser.email} (${currentUser.role})`;
  renderCompanyList();
}

function renderCompanyList(){
  const companyList=document.getElementById('companyList');
  companyList.innerHTML='';
  Object.keys(companyData).forEach(n=>{
    const d=document.createElement('div');
    d.textContent=n;
    d.onclick=()=>openCompany(n);
    companyList.appendChild(d);
  });
}

async function addCompany(){
  const name = document.getElementById('newCompanyName').value.trim();
  if(!name){ alert('Introduce un nombre'); return; }
  if(companyData[name]){ alert('Ya existe esa empresa'); return; }

  companyData[name]={ calendar:{}, templates:[] };
  document.getElementById('newCompanyName').value='';
  currentCompany=name;

  await db.ref(`users/${currentUser.uid}/companies/${name}`).set(companyData[name]);
  renderCompanyList();
  await openCompany(name);
}

/* ================= CALENDARIO ================= */
async function openCompany(name){
  show('loadingScreen'); hide('companyMenu');
  currentCompany=name;
  const now=new Date();
  currentMonth=now.getMonth();
  currentYear=now.getFullYear();
  selectedDay=null;

  await ensureCompanyReady();
  renderCalendar();
}

async function ensureCompanyReady(){
  let attempts=0;
  while(attempts<10){
    const snapshot = await db.ref('users/' + currentUser.uid + '/companies').once('value');
    companyData = snapshot.val() || {};
    if(companyData[currentCompany]) return;
    await new Promise(res=>setTimeout(res,200));
    attempts++;
  }
  companyData[currentCompany]={calendar:{}};
}

function renderCalendar(){
  hide('loadingScreen'); show('calendarView');

  const calendarEl=document.getElementById('calendar');
  const titleEl=document.getElementById('calendarTitle');
  calendarEl.innerHTML='';

  // Mostrar nombre del mes
  const monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio",
                    "Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  titleEl.textContent=`${monthNames[currentMonth]} ${currentYear}`;

  // Días de la semana
  const weekDays=["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
  weekDays.forEach(d=>{
    const cell=document.createElement('div');
    cell.textContent=d;
    cell.style.fontWeight="bold";
    cell.style.background="#eee";
    calendarEl.appendChild(cell);
  });

  const firstDay=new Date(currentYear,currentMonth,1).getDay(); // 0=Domingo
  let offset = firstDay===0 ? 6 : firstDay-1; // Ajustar lunes=0
  for(let i=0;i<offset;i++){
    const empty=document.createElement('div');
    calendarEl.appendChild(empty);
  }

  const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
  const today=new Date();
  for(let d=1;d<=daysInMonth;d++){
    const cell=document.createElement('div');
    cell.textContent=d;
    if(d===today.getDate() && currentMonth===today.getMonth() && currentYear===today.getFullYear()){
      cell.classList.add('today');
    }
    cell.onclick=()=>{
      selectedDay=d;
      document.querySelectorAll('#calendar div').forEach(c=>c.classList.remove('selected'));
      cell.classList.add('selected');
      // Aquí puedes añadir futuras funciones de eventos/tareas
    };
    calendarEl.appendChild(cell);
  }
}

/* ================= BOTÓN VOLVER ================= */
function backToMenu(){
  selectedDay=null;
  currentCompany=null;
  hide('calendarView'); show('companyMenu');
}

/* ================= LOGOUT ================= */
function logout(){ auth.signOut(); }

/* ================= NAV LOGIN/REGISTER ================= */
function showRegister(){ hide('loginView'); show('registerView'); }
function showLogin(){ hide('registerView'); show('loginView'); }

/* ================= REGISTRO ================= */
async function register(){
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value;
  const role=document.getElementById('regRole').value;
  if(!email || !password){ alert('Rellena email y contraseña'); return; }
  try{
    const cred = await auth.createUserWithEmailAndPassword(email,password);
    await db.ref('users/' + cred.user.uid).set({email:email, role:role, createdAt:Date.now()});
    alert('Cuenta creada correctamente. Ya puedes iniciar sesión.');
    showLogin();
  } catch(e){ alert('Error al crear cuenta: '+e.message); }
}
</script>

</body>
</html>
